---
title: "ANES Data"
format: html
---

```{r}
#| label: packages
#| message: FALSE

library(tidyverse)
library(readr)
library(survey)
library(ggplot2)
library(scales)
library(dplyr)
library(ggforce)
library(ggridges)
```

```{r}
#| label: data
#| message: FALSE
#| warning: FALSE

anes_2024 <- read_csv("../Python Files/Streamlit/data/ANES_2024.csv")
```

```{r}
#| label: data-cleaning

anes_2024_sunshine <- anes_2024 |>
  select(
    V240107a, V240107b, V240107c, V240107d, V241422, V241458x, V241459, V241463, V241501x, V241551, V241567x, V241025, V241227x, V241177, V241178, V242067, V241156, V241157, V241158, V241164, V241166, V241167, V241263x, V241266x, V241269x, V241272x, V241275x, V241278x, V241281x, V241284x, V241287x, V241290x, V241302, V241308x, V241312x, V241313, V241319x, V241322x, V241333x, V241366x, V241369x, V241372x, V241375x, V241378x, V241381x, V241385x, V241389x, V241392x, V241395x, V241400x, V241403x, V241406x, V241409x, V241412x, V241579, V242125, V242126, V242134, V242135, V242136, V242137, V242138, V242139, V242140, V242141, V242142, V242143, V242144, V242145, V242146, V242147, V242148, V242149, V242150, V242151, V242152, V242153, V242154, V242155, V242156, V242226x, V242227, V242228, V242231x, V242232, V242235, V242236, V242241x, V242245x, V242248x, V242249, V242253x, V242254, V242279x, V242315, V242316a, V242319x, V242320, V242321, V242324x, V242325, V242328x, V242331x, V242335x, V242336, V242346x, V242349x, V242350, V242353x, V242357x, V242361x, V242364x, V242365, V242366, V242367, V242368, V242369, V242370, V242514, V242515, V242516, V242517, V242518
  ) |>
  rename(
    # weights
    pre_full = V240107a, 
    post_full = V240107b, 
    full_var_psu = V240107c, 
    full_var_stratum = V240107d, 
    
    # demographics
    religion = V241422, 
    age_election_day = V241458x, 
    marriage = V241459, 
    educ = V241463, 
    race_ethnicity = V241501x, 
    gender = V241551, 
    income = V241567x, 
    
    # lib-con / party
    poli_party_reg = V241025, 
    poli_party_self_7pt = V241227x, 
    lib_con_7pt = V241177, 
    lib_con_2pt = V241178,
    pres_vote = V242067, 
    
    # pre-survey thermometer
    harris_thermometer_pre = V241156, 
    trump_thermometer_pre = V241157, 
    biden_thermometer_pre = V241158, 
    vance_thermometer_pre = V241164, 
    democrat_thermometer_pre = V241166, 
    republican_thermometer_pre = V241167, 
    
    # issue positions
    budget_social_security = V241263x, 
    budget_public_schools = V241266x, 
    budget_border_security = V241269x, 
    budget_crime = V241272x, 
    budget_welfare = V241275x, 
    budget_highways = V241278x, 
    budget_aid_poor = V241281x, 
    budget_environment = V241284x, 
    colleges_run = V241287x, 
    dei = V241290x, 
    abortion = V241302, 
    death_penalty = V241308x, 
    us_world_involvement = V241312x, 
    international_force = V241313, 
    voting_id = V241319x, 
    voting_felons = V241322x, 
    journalists = V241333x, 
    climate_inc_temps = V241366x, 
    paid_leave = V241369x, 
    transgender_bathrooms = V241372x, 
    transgender_sports = V241375x, 
    lgbt_discrimination = V241378x, 
    lgbt_adoption = V241381x, 
    gay_marriage = V241385x, 
    birthright_citizenship = V241389x, 
    children_immigrants = V241392x, 
    mexico_wall = V241395x, 
    ukraine_russia = V241400x, 
    israel = V241403x, 
    palestine_aid = V241406x, 
    israel_palestine = V241409x, 
    gaza_protests = V241412x, 
    political_violence = V241579,
    
    # post election survey
    
    # thermometers
    harris_thermometer_post = V242125, 
    trump_thermometer_post = V242126, 
    walz_thermometer_post = V242134, 
    vance_thermometer_post = V242135, 
    biden_thermometer_post = V242136, 
    christian_fundamentalists_thermometer = V242137, 
    feminists_thermometer = V242138, 
    liberals_thermometer = V242139, 
    labor_unions_thermometer = V242140, 
    big_business_thermometer = V242141, 
    conservatives_thermometer = V242142, 
    supreme_court_thermometer = V242143, 
    lgbt_thermometer = V242144, 
    congress_thermometer = V242145, 
    muslims_thermometer = V242146, 
    christians_thermometer = V242147, 
    maga_thermometer = V242148, 
    jews_thermometer = V242149, 
    police_thermometer = V242150, 
    transgender_thermometer = V242151, 
    blm_thermometer = V242152, 
    nra_thermometer = V242153, 
    fbi_thermometer = V242154, 
    rural_thermometer = V242155, 
    planned_parenthood_thermometer = V242156,
    asian_thermometer = V242514,
    hispanic_thermometer = V242515,
    black_thermometer = V242516,
    illegal_immigrant_thermometer = V242517,
    white_thermometer = V242518,
    
    # issue positions
    import_limits = V242226x, 
    immigration_levels = V242227, 
    immigration_jobs = V242228, 
    immigration_crime = V242231x, 
    immigration_citizenship = V242232, 
    immigration_economy = V242235, 
    immigration_customs = V242236, 
    hiring_black = V242241x, 
    affirmative_action = V242245x, 
    gov_involvement = V242248x, 
    gov_regulation = V242249, 
    income_inequality = V242253x, 
    equal_opportunity = V242254, 
    gender_roles = V242279x, 
    budget_deficit = V242315, 
    tax_millionaires = V242316a, 
    vaccines_schools = V242319x, 
    obamacare = V242320, 
    climate_temps = V242321, 
    climate_regulate_emissions = V242324x, 
    gun_difficulty = V242325, 
    gun_background_checks = V242328x, 
    gun_ban_assault_rifles = V242331x, 
    opioid_epidemic = V242335x, 
    police_force = V242336, 
    free_trade = V242346x, 
    diversity = V242349x, 
    federal_min_wage = V242350, 
    budget_healthcare = V242353x, 
    vaccines = V242357x, 
    sexual_harassment = V242361x, 
    transgender_military = V242364x, 
    china_threat = V242365, 
    russia_threat = V242366, 
    mexico_threat = V242367, 
    iran_threat = V242368, 
    japan_threat = V242369, 
    israel_threat = V242370
  )

#write.csv(anes_2024_sunshine, file = "~/Downloads/anes_clean.csv")
```

```{r}
#| label: eda

anes_2024_sunshine |>
  count(poli_party_self_7pt)

anes_2024_sunshine |>
  filter(poli_party_self_7pt > 0) |>
  ggplot(aes(x = poli_party_self_7pt)) +
  geom_bar()

anes_2024_sunshine |>
  filter(lib_con_7pt > 0) |>
  filter(lib_con_7pt < 90) |>
  ggplot(aes(x = lib_con_7pt)) +
  geom_bar()

anes_2024_sunshine |>
  filter(gun_difficulty > 0) |>
  filter(poli_party_reg > 0) |>
  filter(poli_party_reg < 5) |>
  mutate(
  gun_difficulty = case_when(
    gun_difficulty == 1 ~ "More difficult", 
    gun_difficulty == 2 ~ "Easier", 
    gun_difficulty == 3 ~ "Keep these rules about the same"
  ),
  gun_difficulty = factor(gun_difficulty, levels = c(
    "Easier", 
    "Keep these rules about the same", 
    "More difficult"
  )),
  poli_party_reg = case_when(
    poli_party_reg == 1 ~ "Democratic party",
    poli_party_reg == 2 ~ "Republican party",
    poli_party_reg == 4 ~ "None or independent"
  ), 
  poli_party_reg = factor(poli_party_reg, levels = c(
    "None or independent",
    "Republican party",
    "Democratic party"
  ))
  ) |>
  ggplot(aes(y = poli_party_reg, fill = gun_difficulty)) +
  geom_bar(position = "fill") +
  theme_minimal() +
  scale_x_continuous(labels = label_percent()) +
  labs(
    title = "Do you think the federal government should make it more
difficult for people to buy a gun than it is now, make it easier
for people to buy a gun, or keep these rules about the same
as they are now?", 
  x = "Percentage of Respondents", 
  y = "Respondent's Registered Political Party", 
  fill = "Response"
  ) 
```

```{r}
#| label: gun-plots

anes_2024_sunshine |>
  filter(gun_background_checks > 0) |>
  filter(poli_party_reg %in% c(1, 2, 4)) |>
  mutate(
  gun_background_checks = case_when(
      gun_background_checks == 1 ~ "Favor a great deal",
      gun_background_checks == 2 ~ "Favor moderately",
      gun_background_checks == 3 ~ "Favor a little",
      gun_background_checks == 4 ~ "Neither",
      gun_background_checks == 5 ~ "Oppose a little",
      gun_background_checks == 6 ~ "Oppose moderately",
      gun_background_checks == 7 ~ "Oppose a great deal"
    ),
    gun_background_checks = factor(gun_background_checks, levels = c(
      "Oppose a great deal",
      "Oppose moderately",
      "Oppose a little",
      "Neither",
      "Favor a little",
      "Favor moderately",
      "Favor a great deal"
    )),
  poli_party_reg = case_when(
    poli_party_reg == 1 ~ "Democratic party",
    poli_party_reg == 2 ~ "Republican party",
    poli_party_reg == 4 ~ "None or independent"
  ), 
  poli_party_reg = factor(poli_party_reg, levels = c(
    "None or independent",
    "Republican party",
    "Democratic party"
  ))
  ) |>
  ggplot(aes(y = poli_party_reg, fill = gun_background_checks)) +
  geom_bar(position = "fill") +
  scale_x_continuous(labels = label_percent()) +
  scale_fill_brewer(palette = "RdBu") +
  labs(
    title = "Opinions on Gun Background Checks by Party", 
    x = "Percentage", 
    y = "Political Party", 
    fill = "Response"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")



anes_2024_sunshine |>
  filter(between(gun_background_checks, 1, 7)) |>
  filter(poli_party_reg %in% c(1, 2, 4)) |>
  mutate(
    gun_background_checks = case_when(
      gun_background_checks == 1 ~ "Favor a great deal",
      gun_background_checks == 2 ~ "Favor moderately",
      gun_background_checks == 3 ~ "Favor a little",
      gun_background_checks == 4 ~ "Neither",
      gun_background_checks == 5 ~ "Oppose a little",
      gun_background_checks == 6 ~ "Oppose moderately",
      gun_background_checks == 7 ~ "Oppose a great deal"
    ),
    gun_background_checks = factor(gun_background_checks, levels = c(
      "Oppose a great deal",
      "Oppose moderately",
      "Oppose a little",
      "Neither",
      "Favor a little",
      "Favor moderately",
      "Favor a great deal"
    )),
    poli_party_reg = case_when(
      poli_party_reg == 1 ~ "Democrat",
      poli_party_reg == 4 ~ "None or independent",
      poli_party_reg == 2 ~ "Republican"
    )
  ) |>
  count(poli_party_reg, gun_background_checks) |>
  group_by(poli_party_reg) |>
  mutate(percent = n / sum(n)) |>
  ggplot(aes(x = percent, y = gun_background_checks, fill = gun_background_checks)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~ poli_party_reg, nrow = 1) +
  scale_x_continuous(labels = label_percent()) +
  scale_fill_brewer(palette = "RdBu") +
  labs(
    title = "Opinions on Gun Background Checks by Party",
    x = "Percentage",
    y = NULL,
    fill = "Response"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")


anes_2024_sunshine |>
  filter(between(gun_background_checks, 1, 7)) |>
  filter(poli_party_reg %in% c(1, 2, 4)) |>
  mutate(
    party = case_when(
      poli_party_reg == 1 ~ "Democrat",
      poli_party_reg == 2 ~ "Republican",
      poli_party_reg == 4 ~ "None or independent"
    )
  ) |>
  group_by(party) |>
  summarise(
    mean_position = mean(gun_background_checks),
    sd_position = sd(gun_background_checks),
    n = n()
  )
```

```{r}
#| label: mirror

anes_2024_sunshine |>
  mutate(
    party = case_when(
      poli_party_reg == 1 ~ "Democratic",
      poli_party_reg == 2 ~ "Republican",
      TRUE ~ NA_character_
    )
  ) |>
  filter(
    !is.na(post_full),
    !is.na(party),
    party %in% c("Democratic", "Republican"),
    gun_ban_assault_rifles %in% 1:7
  ) |>
  group_by(party) |>
  summarize(
    mean_bg = weighted.mean(gun_ban_assault_rifles, post_full, na.rm = TRUE),
    .groups = "drop"
  ) |>
  mutate(
    text_y = if_else(party == "Democratic", 1.2, -1.2)
  ) |>
  ggplot() +
  geom_circle(
    aes(x0 = mean_bg, y0 = 0, r = radius, fill = party),
    color = NA, alpha = 0.4
  ) +
  geom_point(aes(x = mean_bg, y = 0, color = party), size = 4) +
  geom_text(aes(x = mean_bg, y = text_y, label = party, color = party)) +
  scale_fill_manual(values = c(Democratic = "blue", Republican = "red")) +
  scale_color_manual(values = c(Democratic = "blue", Republican = "red")) +
  scale_x_continuous(
    breaks = 1:7,
    labels = c(
      "1\nStrongly\nOppose", "2\nSomewhat\nOppose", "3\nLean\nOppose",
      "4\nNeutral", "5\nLean\nFavor", "6\nSomewhat\nFavor", "7\nStrongly\nFavor"
    ),
    limits = c(1 - 1 - 0.2, 7 + 1 + 0.2)
  ) +
  scale_y_continuous(limits = c(-2, 2), breaks = NULL) +
  coord_fixed() +
  labs(
    title = "Empathy Mirror: Background Check Support by Party",
    x = "Support",
    y = NULL
  ) +
  theme_minimal() +
  theme(
    axis.ticks.y = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold", hjust = 0.5),
    legend.position = "none"
  )



anes_2024_sunshine |>
  mutate(
    party = case_when(
      poli_party_reg == 1 ~ "Democratic",
      poli_party_reg == 2 ~ "Republican",
      TRUE ~ NA_character_
    )
  ) |>
  filter(
    !is.na(post_full),
    !is.na(party),
    party %in% c("Democratic", "Republican"),
    gun_ban_assault_rifles %in% 1:7
  ) |>
  group_by(party) |>
  summarize(
    mean_bg = weighted.mean(gun_ban_assault_rifles, post_full, na.rm = TRUE),
    sd_bg = sqrt(weighted.mean((gun_ban_assault_rifles - weighted.mean(gun_ban_assault_rifles, post_full, na.rm = TRUE))^2, post_full, na.rm = TRUE)),
    .groups = "drop"
  ) |>
  mutate(
    text_y = if_else(party == "Democratic", 1.5, -1.5),
    a = sd_bg,           # semi-major axis (horizontal, e.g. std. dev)
    b = 0.8              # semi-minor axis (vertical, fixed for clarity)
  ) |>
  ggplot() +
  geom_ellipse(
    aes(x0 = mean_bg, y0 = 0, a = a, b = b, angle = 0, fill = party),
    alpha = 0.4, color = NA
  ) +
  geom_point(aes(x = mean_bg, y = 0, color = party), size = 4) +
  geom_text(aes(x = mean_bg, y = text_y, label = party, color = party)) +
  scale_fill_manual(values = c(Democratic = "blue", Republican = "red")) +
  scale_color_manual(values = c(Democratic = "blue", Republican = "red")) +
  scale_x_continuous(
    breaks = 1:7,
    labels = c(
      "1\nStrongly\nOppose", "2\nSomewhat\nOppose", "3\nLean\nOppose",
      "4\nNeutral", "5\nLean\nFavor", "6\nSomewhat\nFavor", "7\nStrongly\nFavor"
    ),
    limits = c(1 - 2, 7 + 2)
  ) +
  scale_y_continuous(limits = c(-2, 2), breaks = NULL) +
  coord_fixed() +
  labs(
    title = "Empathy Mirror: Background Check Support by Party",
    x = "Support",
    y = NULL
  ) +
  theme_minimal() +
  theme(
    axis.ticks.y = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold", hjust = 0.5),
    legend.position = "none"
  )




anes_2024_sunshine |>
  mutate(
    party = case_when(
      poli_party_reg == 1 ~ "Democratic",
      poli_party_reg == 2 ~ "Republican",
      TRUE ~ NA_character_
    )
  ) |>
  filter(
    !is.na(post_full),
    !is.na(party),
    party %in% c("Democratic", "Republican"),
    gun_ban_assault_rifles %in% 1:7
  ) |>
  group_by(party) |>
  summarize(
    mean_bg = weighted.mean(gun_ban_assault_rifles, post_full, na.rm = TRUE),
    sd_bg = sqrt(weighted.mean((gun_ban_assault_rifles - weighted.mean(gun_ban_assault_rifles, post_full, na.rm = TRUE))^2, post_full, na.rm = TRUE)),
    .groups = "drop"
  ) |>
  mutate(
    y = if_else(party == "Democratic", 1, 0)  # Fixed y-values for layout
  ) |>
  ggplot() +
  geom_errorbarh(
    aes(y = y, xmin = mean_bg - sd_bg, xmax = mean_bg + sd_bg, color = party),
    height = 0.2, linewidth = 1
  ) +
  geom_point(aes(x = mean_bg, y = y, color = party), size = 4) +
  geom_text(aes(x = mean_bg, y = y + 0.3, label = party, color = party)) +
  scale_color_manual(values = c(Democratic = "blue", Republican = "red")) +
  scale_x_continuous(
    breaks = 1:7,
    labels = c(
      "1\nStrongly\nOppose", "2\nSomewhat\nOppose", "3\nLean\nOppose",
      "4\nNeutral", "5\nLean\nFavor", "6\nSomewhat\nFavor", "7\nStrongly\nFavor"
    ),
    limits = c(1 - 1.5, 7 + 1.5)
  ) +
  scale_y_continuous(
    breaks = c(0, 1),
    labels = c("Republican", "Democratic"),
    limits = c(-0.5, 1.5)
  ) +
  coord_cartesian(clip = "off") +
  labs(
    title = "Empathy Mirror: Background Check Support by Party",
    x = "Support",
    y = NULL
  ) +
  theme_minimal() +
  theme(
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold", hjust = 0.5),
    legend.position = "none"
  )



anes_2024_sunshine |>
  mutate(
    party = case_when(
      poli_party_reg == 1 ~ "Democratic",
      poli_party_reg == 2 ~ "Republican",
      TRUE ~ NA_character_
    )
  ) |>
  filter(
    !is.na(post_full),
    !is.na(party),
    party %in% c("Democratic", "Republican"),
    gun_ban_assault_rifles %in% 1:7
  ) |>
  ggplot(aes(
    x = gun_ban_assault_rifles,
    y = party,
    fill = party,
    weight = post_full
  )) +
  geom_density_ridges(
    scale = 1.2,
    alpha = 0.5,
    color = NA
  ) +
  scale_fill_manual(values = c(Democratic = "blue", Republican = "red")) +
  scale_x_continuous(
    breaks = 1:7,
    labels = c(
      "1\nStrongly\nOppose", "2\nSomewhat\nOppose", "3\nLean\nOppose",
      "4\nNeutral", "5\nLean\nFavor", "6\nSomewhat\nFavor", "7\nStrongly\nFavor"
    ),
    limits = c(1, 7)
  ) +
  labs(
    title = "Distribution of Support for Background Checks by Party",
    x = "Support",
    y = NULL
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    legend.position = "none"
  )
```

```{r}
#| label: more-plots

anes_2024_sunshine |>
  mutate(
    party = case_when(
      poli_party_reg == 1 ~ "Democratic",
      poli_party_reg == 2 ~ "Republican",
      TRUE ~ NA_character_
    )
  ) |>
  filter(
    !is.na(post_full),
    !is.na(party),
    party %in% c("Democratic", "Republican"),
    maga_thermometer >= 0 & maga_thermometer <= 100
  ) |>
  ggplot(aes(x = maga_thermometer, color = party, fill = party, weight = post_full)) +
  geom_density(alpha = 0.3, linewidth = 1.2) +
  scale_fill_manual(values = c(Democratic = "blue", Republican = "red")) +
  scale_color_manual(values = c(Democratic = "blue", Republican = "red")) +
  scale_x_continuous(
    breaks = seq(0, 100, by = 20),
    limits = c(0, 100)
  ) +
  labs(
    title = "Overlayed Density of MAGA Thermometer Ratings by Party",
    x = "Thermometer Rating (0–100)",
    y = "Density"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5)
  )

```



```{r}
#| label: weights

anes_2024_clean <- read_csv("../Python Files/Streamlit/data/ANES_2024_clean.csv")

anes_subset <- subset(anes_2024_clean, 
                      !is.na(full_var_psu) & 
                      !is.na(full_var_stratum) & 
                      !is.na(post_full))

# Define the design object using post-election weights (example)
anes_design <- svydesign(
  ids = ~full_var_psu,
  strata = ~full_var_stratum,
  weights = ~post_full,
  data = anes_subset,
  nest = TRUE
)

# Use svytable() to get proper weighted counts
tab <- svytable(~V242325, design = anes_design)
df <- as.data.frame(tab)
names(df) <- c("response", "weighted_count")

df <- df |>
  mutate(response = case_when(
    response == -9 ~ "Refused", 
    response == -8 ~ "Don’t know",
    response == -7 ~ "Insufficient partial, interview deleted",
    response == -6 ~ "No post interview",
    response == -5 ~ "Sufficient partial, breakoff",
    response == -1 ~ "Inapplicable",
    response == 1 ~ "More difficult",
    response == 2 ~ "Easier",
    response == 3 ~ "Keep these rules about the same"
  ))


ggplot(df, aes(y = response, x = weighted_count)) +
  geom_bar(stat = "identity") +
  labs(title = "Do you think the federal government should make it more
difficult for people to buy a gun than it is now, make it easier
for people to buy a gun, or keep these rules about the same
as they are now?",
       x = "Response", y = "Weighted Count") +
    scale_x_continuous(labels = scales::comma_format()) +
  theme_minimal()




# Step 1: Clean + recode
anes_subset_2 <- anes_2024_clean |>
  filter(
    !is.na(full_var_psu),
    !is.na(full_var_stratum),
    !is.na(post_full),
    !is.na(V242325),
    !is.na(poli_party_reg)
  ) |>
  mutate(
    V242325 = case_when(
      V242325 == -9 ~ "Refused", 
      V242325 == -8 ~ "Don’t know",
      V242325 == -7 ~ "Insufficient partial, interview deleted",
      V242325 == -6 ~ "No post interview",
      V242325 == -5 ~ "Sufficient partial, breakoff",
      V242325 == -1 ~ "Inapplicable",
      V242325 == 1 ~ "More difficult",
      V242325 == 2 ~ "Easier",
      V242325 == 3 ~ "Keep these rules about the same"
    ),
    poli_party_reg = case_when(
      poli_party_reg == -9 ~ "Refused",
      poli_party_reg == -8 ~ "Don’t know",
      poli_party_reg == -1 ~ "Inapplicable",
      poli_party_reg == 1 ~ "Democratic party",
      poli_party_reg == 2 ~ "Republican party",
      poli_party_reg == 4 ~ "None or independent",
      poli_party_reg == 5 ~ "Another party"
    )
  )

# Step 2: Define survey design
anes_design <- svydesign(
  ids = ~full_var_psu,
  strata = ~full_var_stratum,
  weights = ~post_full,
  data = anes_subset_2,
  nest = TRUE
)

# Step 3: Get weighted counts by response and party
tab <- svytable(~poli_party_reg + V242325, design = anes_design)
df <- as.data.frame(tab)
names(df) <- c("poli_party_reg", "V242325", "weighted_count")

# Step 4: Plot
ggplot(df, aes(y = poli_party_reg, x = weighted_count, fill = V242325)) +
  geom_col(position = "fill") +
  scale_x_continuous(labels = scales::percent_format()) +
  labs(
    title = "Do you think the federal government should make it more
difficult for people to buy a gun than it is now, make it easier
for people to buy a gun, or keep these rules about the same?"
  ) +
  theme_minimal()
```
---
title: "ANES Data"
format: html
---

```{r}
#| label: packages
#| message: FALSE

library(tidyverse)
library(readr)
library(survey)
library(ggplot2)
library(scales)
library(dplyr)
library(ggforce)
library(ggridges)
```

```{r}
#| label: data
#| message: FALSE
#| warning: FALSE

#anes_2024 <- read_csv("../Python Files/Streamlit/data/ANES_2024.csv")
anes_2024_sunshine <- read_csv("../data/anes_2024_clean.csv")
```

```{r}
#| label: data-cleaning

anes_2024_sunshine <- anes_2024 |>
  select(
    V240107a, V240107b, V240107c, V240107d, V241422, V241458x, V241459, V241463, V241501x, V241551, V241567x, V241025, V241227x, V241177, V241178, V242067, V241156, V241157, V241158, V241164, V241166, V241167, V241263x, V241266x, V241269x, V241272x, V241275x, V241278x, V241281x, V241284x, V241287x, V241290x, V241302, V241308x, V241312x, V241313, V241319x, V241322x, V241333x, V241366x, V241369x, V241372x, V241375x, V241378x, V241381x, V241385x, V241389x, V241392x, V241395x, V241400x, V241403x, V241406x, V241409x, V241412x, V241579, V242125, V242126, V242134, V242135, V242136, V242137, V242138, V242139, V242140, V242141, V242142, V242143, V242144, V242145, V242146, V242147, V242148, V242149, V242150, V242151, V242152, V242153, V242154, V242155, V242156, V242226x, V242227, V242228, V242231x, V242232, V242235, V242236, V242241x, V242245x, V242248x, V242249, V242253x, V242254, V242279x, V242315, V242316a, V242319x, V242320, V242321, V242324x, V242325, V242328x, V242331x, V242335x, V242336, V242346x, V242349x, V242350, V242353x, V242357x, V242361x, V242364x, V242365, V242366, V242367, V242368, V242369, V242370, V242514, V242515, V242516, V242517, V242518
  ) |>
  rename(
    # weights
    pre_full = V240107a, 
    post_full = V240107b, 
    full_var_psu = V240107c, 
    full_var_stratum = V240107d, 
    
    # demographics
    religion = V241422, 
    age_election_day = V241458x, 
    marriage = V241459, 
    educ = V241463, 
    race_ethnicity = V241501x, 
    gender = V241551, 
    income = V241567x, 
    
    # lib-con / party
    poli_party_reg = V241025, 
    poli_party_self_7pt = V241227x, 
    lib_con_7pt = V241177, 
    lib_con_2pt = V241178,
    pres_vote = V242067, 
    
    # pre-survey thermometer
    harris_thermometer_pre = V241156, 
    trump_thermometer_pre = V241157, 
    biden_thermometer_pre = V241158, 
    vance_thermometer_pre = V241164, 
    democrat_thermometer_pre = V241166, 
    republican_thermometer_pre = V241167, 
    
    # issue positions
    budget_social_security = V241263x, 
    budget_public_schools = V241266x, 
    budget_border_security = V241269x, 
    budget_crime = V241272x, 
    budget_welfare = V241275x, 
    budget_highways = V241278x, 
    budget_aid_poor = V241281x, 
    budget_environment = V241284x, 
    colleges_run = V241287x, 
    dei = V241290x, 
    abortion = V241302, 
    death_penalty = V241308x, 
    us_world_involvement = V241312x, 
    international_force = V241313, 
    voting_id = V241319x, 
    voting_felons = V241322x, 
    journalists = V241333x, 
    climate_inc_temps = V241366x, 
    paid_leave = V241369x, 
    transgender_bathrooms = V241372x, 
    transgender_sports = V241375x, 
    lgbt_discrimination = V241378x, 
    lgbt_adoption = V241381x, 
    gay_marriage = V241385x, 
    birthright_citizenship = V241389x, 
    children_immigrants = V241392x, 
    mexico_wall = V241395x, 
    ukraine_russia = V241400x, 
    israel = V241403x, 
    palestine_aid = V241406x, 
    israel_palestine = V241409x, 
    gaza_protests = V241412x, 
    political_violence = V241579,
    
    # post election survey
    
    # thermometers
    harris_thermometer_post = V242125, 
    trump_thermometer_post = V242126, 
    walz_thermometer_post = V242134, 
    vance_thermometer_post = V242135, 
    biden_thermometer_post = V242136, 
    christian_fundamentalists_thermometer = V242137, 
    feminists_thermometer = V242138, 
    liberals_thermometer = V242139, 
    labor_unions_thermometer = V242140, 
    big_business_thermometer = V242141, 
    conservatives_thermometer = V242142, 
    supreme_court_thermometer = V242143, 
    lgbt_thermometer = V242144, 
    congress_thermometer = V242145, 
    muslims_thermometer = V242146, 
    christians_thermometer = V242147, 
    maga_thermometer = V242148, 
    jews_thermometer = V242149, 
    police_thermometer = V242150, 
    transgender_thermometer = V242151, 
    blm_thermometer = V242152, 
    nra_thermometer = V242153, 
    fbi_thermometer = V242154, 
    rural_thermometer = V242155, 
    planned_parenthood_thermometer = V242156,
    asian_thermometer = V242514,
    hispanic_thermometer = V242515,
    black_thermometer = V242516,
    illegal_immigrant_thermometer = V242517,
    white_thermometer = V242518,
    
    # issue positions
    import_limits = V242226x, 
    immigration_levels = V242227, 
    immigration_jobs = V242228, 
    immigration_crime = V242231x, 
    immigration_citizenship = V242232, 
    immigration_economy = V242235, 
    immigration_customs = V242236, 
    hiring_black = V242241x, 
    affirmative_action = V242245x, 
    gov_involvement = V242248x, 
    gov_regulation = V242249, 
    income_inequality = V242253x, 
    equal_opportunity = V242254, 
    gender_roles = V242279x, 
    budget_deficit = V242315, 
    tax_millionaires = V242316a, 
    vaccines_schools = V242319x, 
    obamacare = V242320, 
    climate_temps = V242321, 
    climate_regulate_emissions = V242324x, 
    gun_difficulty = V242325, 
    gun_background_checks = V242328x, 
    gun_ban_assault_rifles = V242331x, 
    opioid_epidemic = V242335x, 
    police_force = V242336, 
    free_trade = V242346x, 
    diversity = V242349x, 
    federal_min_wage = V242350, 
    budget_healthcare = V242353x, 
    vaccines = V242357x, 
    sexual_harassment = V242361x, 
    transgender_military = V242364x, 
    china_threat = V242365, 
    russia_threat = V242366, 
    mexico_threat = V242367, 
    iran_threat = V242368, 
    japan_threat = V242369, 
    israel_threat = V242370
  )

#write.csv(anes_2024_sunshine, file = "~/Downloads/anes_2024_clean.csv")
```

```{r}
#| label: eda

anes_2024_sunshine |>
  count(lib_con_7pt)

anes_2024_sunshine |>
  filter(poli_party_self_7pt > 0) |>
  ggplot(aes(x = poli_party_self_7pt)) +
  geom_bar()

anes_2024_sunshine |>
  filter(lib_con_7pt > 0) |>
  filter(lib_con_7pt < 90) |>
  ggplot(aes(x = lib_con_7pt)) +
  geom_bar()

anes_2024_sunshine |>
  filter(gun_difficulty > 0) |>
  filter(poli_party_reg > 0) |>
  filter(poli_party_reg < 5) |>
  mutate(
  gun_difficulty = case_when(
    gun_difficulty == 1 ~ "More difficult", 
    gun_difficulty == 2 ~ "Easier", 
    gun_difficulty == 3 ~ "Keep these rules about the same"
  ),
  gun_difficulty = factor(gun_difficulty, levels = c(
    "Easier", 
    "Keep these rules about the same", 
    "More difficult"
  )),
  poli_party_reg = case_when(
    poli_party_reg == 1 ~ "Democratic party",
    poli_party_reg == 2 ~ "Republican party",
    poli_party_reg == 4 ~ "None or independent"
  ), 
  poli_party_reg = factor(poli_party_reg, levels = c(
    "None or independent",
    "Republican party",
    "Democratic party"
  ))
  ) |>
  ggplot(aes(y = poli_party_reg, fill = gun_difficulty)) +
  geom_bar(position = "fill") +
  theme_minimal() +
  scale_x_continuous(labels = label_percent()) +
  labs(
    title = "Do you think the federal government should make it more
difficult for people to buy a gun than it is now, make it easier
for people to buy a gun, or keep these rules about the same
as they are now?", 
  x = "Percentage of Respondents", 
  y = "Respondent's Registered Political Party", 
  fill = "Response"
  ) 
```

```{r}
#| label: gun-plots

anes_2024_sunshine |>
  filter(gun_background_checks > 0) |>
  filter(poli_party_reg %in% c(1, 2, 4)) |>
  mutate(
  gun_background_checks = case_when(
      gun_background_checks == 1 ~ "Favor a great deal",
      gun_background_checks == 2 ~ "Favor moderately",
      gun_background_checks == 3 ~ "Favor a little",
      gun_background_checks == 4 ~ "Neither",
      gun_background_checks == 5 ~ "Oppose a little",
      gun_background_checks == 6 ~ "Oppose moderately",
      gun_background_checks == 7 ~ "Oppose a great deal"
    ),
    gun_background_checks = factor(gun_background_checks, levels = c(
      "Oppose a great deal",
      "Oppose moderately",
      "Oppose a little",
      "Neither",
      "Favor a little",
      "Favor moderately",
      "Favor a great deal"
    )),
  poli_party_reg = case_when(
    poli_party_reg == 1 ~ "Democratic party",
    poli_party_reg == 2 ~ "Republican party",
    poli_party_reg == 4 ~ "None or independent"
  ), 
  poli_party_reg = factor(poli_party_reg, levels = c(
    "None or independent",
    "Republican party",
    "Democratic party"
  ))
  ) |>
  ggplot(aes(y = poli_party_reg, fill = gun_background_checks)) +
  geom_bar(position = "fill") +
  scale_x_continuous(labels = label_percent()) +
  scale_fill_brewer(palette = "RdBu") +
  labs(
    title = "Opinions on Gun Background Checks by Party", 
    x = "Percentage", 
    y = "Political Party", 
    fill = "Response"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")



anes_2024_sunshine |>
  filter(between(gun_background_checks, 1, 7)) |>
  filter(poli_party_reg %in% c(1, 2, 4)) |>
  mutate(
    gun_background_checks = case_when(
      gun_background_checks == 1 ~ "Favor a great deal",
      gun_background_checks == 2 ~ "Favor moderately",
      gun_background_checks == 3 ~ "Favor a little",
      gun_background_checks == 4 ~ "Neither",
      gun_background_checks == 5 ~ "Oppose a little",
      gun_background_checks == 6 ~ "Oppose moderately",
      gun_background_checks == 7 ~ "Oppose a great deal"
    ),
    gun_background_checks = factor(gun_background_checks, levels = c(
      "Oppose a great deal",
      "Oppose moderately",
      "Oppose a little",
      "Neither",
      "Favor a little",
      "Favor moderately",
      "Favor a great deal"
    )),
    poli_party_reg = case_when(
      poli_party_reg == 1 ~ "Democrat",
      poli_party_reg == 4 ~ "None or independent",
      poli_party_reg == 2 ~ "Republican"
    )
  ) |>
  count(poli_party_reg, gun_background_checks) |>
  group_by(poli_party_reg) |>
  mutate(percent = n / sum(n)) |>
  ggplot(aes(x = percent, y = gun_background_checks, fill = gun_background_checks)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~ poli_party_reg, nrow = 1) +
  scale_x_continuous(labels = label_percent()) +
  scale_fill_brewer(palette = "RdBu") +
  labs(
    title = "Opinions on Gun Background Checks by Party",
    x = "Percentage",
    y = NULL,
    fill = "Response"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")


anes_2024_sunshine |>
  filter(between(gun_background_checks, 1, 7)) |>
  filter(poli_party_reg %in% c(1, 2, 4)) |>
  mutate(
    party = case_when(
      poli_party_reg == 1 ~ "Democrat",
      poli_party_reg == 2 ~ "Republican",
      poli_party_reg == 4 ~ "None or independent"
    )
  ) |>
  group_by(party) |>
  summarise(
    mean_position = mean(gun_background_checks),
    sd_position = sd(gun_background_checks),
    n = n()
  )
```

```{r}
#| label: mirror

anes_2024_sunshine |>
  mutate(
    party = case_when(
      poli_party_reg == 1 ~ "Democratic",
      poli_party_reg == 2 ~ "Republican",
      TRUE ~ NA_character_
    )
  ) |>
  filter(
    !is.na(post_full),
    !is.na(party),
    party %in% c("Democratic", "Republican"),
    gun_ban_assault_rifles %in% 1:7
  ) |>
  group_by(party) |>
  summarize(
    mean_bg = weighted.mean(gun_background_checks, post_full, na.rm = TRUE),
    .groups = "drop"
  ) |>
  mutate(
    text_y = if_else(party == "Democratic", 1.2, -1.2)
  ) |>
  ggplot() +
  geom_circle(
    aes(x0 = mean_bg, y0 = 0, r = 1, fill = party),
    color = NA, alpha = 0.4
  ) +
  geom_point(aes(x = mean_bg, y = 0, color = party), size = 4) +
  geom_text(aes(x = mean_bg, y = text_y, label = party, color = party)) +
  scale_fill_manual(values = c(Democratic = "blue", Republican = "red")) +
  scale_color_manual(values = c(Democratic = "blue", Republican = "red")) +
  scale_x_continuous(
    breaks = 1:7,
    labels = c(
      "1\nStrongly\nOppose", "2\nSomewhat\nOppose", "3\nLean\nOppose",
      "4\nNeutral", "5\nLean\nFavor", "6\nSomewhat\nFavor", "7\nStrongly\nFavor"
    ),
    limits = c(1 - 1 - 0.2, 7 + 1 + 0.2)
  ) +
  scale_y_continuous(limits = c(-2, 2), breaks = NULL) +
  coord_fixed() +
  labs(
    title = "Empathy Mirror: Background Check Support by Party",
    x = "Support",
    y = NULL
  ) +
  theme_minimal() +
  theme(
    axis.ticks.y = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold", hjust = 0.5),
    legend.position = "none"
  )



anes_2024_sunshine |>
  mutate(
    party = case_when(
      poli_party_reg == 1 ~ "Democratic",
      poli_party_reg == 2 ~ "Republican",
      TRUE ~ NA_character_
    )
  ) |>
  filter(
    !is.na(post_full),
    !is.na(party),
    party %in% c("Democratic", "Republican"),
    gun_ban_assault_rifles %in% 1:7
  ) |>
  group_by(party) |>
  summarize(
    mean_bg = weighted.mean(gun_ban_assault_rifles, post_full, na.rm = TRUE),
    sd_bg = sqrt(weighted.mean((gun_ban_assault_rifles - weighted.mean(gun_ban_assault_rifles, post_full, na.rm = TRUE))^2, post_full, na.rm = TRUE)),
    .groups = "drop"
  ) |>
  mutate(
    text_y = if_else(party == "Democratic", 1.5, -1.5),
    a = sd_bg,           # semi-major axis (horizontal, e.g. std. dev)
    b = 0.8              # semi-minor axis (vertical, fixed for clarity)
  ) |>
  ggplot() +
  geom_ellipse(
    aes(x0 = mean_bg, y0 = 0, a = a, b = b, angle = 0, fill = party),
    alpha = 0.4, color = NA
  ) +
  geom_point(aes(x = mean_bg, y = 0, color = party), size = 4) +
  geom_text(aes(x = mean_bg, y = text_y, label = party, color = party)) +
  scale_fill_manual(values = c(Democratic = "blue", Republican = "red")) +
  scale_color_manual(values = c(Democratic = "blue", Republican = "red")) +
  scale_x_continuous(
    breaks = 1:7,
    labels = c(
      "1\nStrongly\nOppose", "2\nSomewhat\nOppose", "3\nLean\nOppose",
      "4\nNeutral", "5\nLean\nFavor", "6\nSomewhat\nFavor", "7\nStrongly\nFavor"
    ),
    limits = c(1 - 2, 7 + 2)
  ) +
  scale_y_continuous(limits = c(-2, 2), breaks = NULL) +
  coord_fixed() +
  labs(
    title = "Empathy Mirror: Background Check Support by Party",
    x = "Support",
    y = NULL
  ) +
  theme_minimal() +
  theme(
    axis.ticks.y = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold", hjust = 0.5),
    legend.position = "none"
  )




anes_2024_sunshine |>
  mutate(
    party = case_when(
      poli_party_reg == 1 ~ "Democratic",
      poli_party_reg == 2 ~ "Republican",
      TRUE ~ NA_character_
    )
  ) |>
  filter(
    !is.na(post_full),
    !is.na(party),
    party %in% c("Democratic", "Republican"),
    gun_ban_assault_rifles %in% 1:7
  ) |>
  group_by(party) |>
  summarize(
    mean_bg = weighted.mean(gun_ban_assault_rifles, post_full, na.rm = TRUE),
    sd_bg = sqrt(weighted.mean((gun_ban_assault_rifles - weighted.mean(gun_ban_assault_rifles, post_full, na.rm = TRUE))^2, post_full, na.rm = TRUE)),
    .groups = "drop"
  ) |>
  mutate(
    y = if_else(party == "Democratic", 1, 0)  # Fixed y-values for layout
  ) |>
  ggplot() +
  geom_errorbarh(
    aes(y = y, xmin = mean_bg - sd_bg, xmax = mean_bg + sd_bg, color = party),
    height = 0.2, linewidth = 1
  ) +
  geom_point(aes(x = mean_bg, y = y, color = party), size = 4) +
  geom_text(aes(x = mean_bg, y = y + 0.3, label = party, color = party)) +
  scale_color_manual(values = c(Democratic = "blue", Republican = "red")) +
  scale_x_continuous(
    breaks = 1:7,
    labels = c(
      "1\nStrongly\nOppose", "2\nSomewhat\nOppose", "3\nLean\nOppose",
      "4\nNeutral", "5\nLean\nFavor", "6\nSomewhat\nFavor", "7\nStrongly\nFavor"
    ),
    limits = c(1 - 1.5, 7 + 1.5)
  ) +
  scale_y_continuous(
    breaks = c(0, 1),
    labels = c("Republican", "Democratic"),
    limits = c(-0.5, 1.5)
  ) +
  coord_cartesian(clip = "off") +
  labs(
    title = "Empathy Mirror: Background Check Support by Party",
    x = "Support",
    y = NULL
  ) +
  theme_minimal() +
  theme(
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold", hjust = 0.5),
    legend.position = "none"
  )



anes_2024_sunshine |>
  mutate(
    party = case_when(
      poli_party_reg == 1 ~ "Democratic",
      poli_party_reg == 2 ~ "Republican",
      TRUE ~ NA_character_
    )
  ) |>
  filter(
    !is.na(post_full),
    !is.na(party),
    party %in% c("Democratic", "Republican"),
    gun_ban_assault_rifles %in% 1:7
  ) |>
  ggplot(aes(
    x = gun_ban_assault_rifles,
    y = party,
    fill = party,
    weight = post_full
  )) +
  geom_density_ridges(
    scale = 1.2,
    alpha = 0.5,
    color = NA
  ) +
  scale_fill_manual(values = c(Democratic = "blue", Republican = "red")) +
  scale_x_continuous(
    breaks = 1:7,
    labels = c(
      "1\nStrongly\nOppose", "2\nSomewhat\nOppose", "3\nLean\nOppose",
      "4\nNeutral", "5\nLean\nFavor", "6\nSomewhat\nFavor", "7\nStrongly\nFavor"
    ),
    limits = c(1, 7)
  ) +
  labs(
    title = "Distribution of Support for Background Checks by Party",
    x = "Support",
    y = NULL
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    legend.position = "none"
  )
```

```{r}
#| label: more-plots

anes_2024_sunshine |>
  mutate(
    party = case_when(
      poli_party_reg == 1 ~ "Democratic",
      poli_party_reg == 2 ~ "Republican",
      TRUE ~ NA_character_
    )
  ) |>
  filter(
    !is.na(post_full),
    !is.na(party),
    party %in% c("Democratic", "Republican"),
    maga_thermometer >= 0 & maga_thermometer <= 100
  ) |>
  ggplot(aes(x = maga_thermometer, color = party, fill = party, weight = post_full)) +
  geom_density(alpha = 0.3, linewidth = 1.2) +
  scale_fill_manual(values = c(Democratic = "blue", Republican = "red")) +
  scale_color_manual(values = c(Democratic = "blue", Republican = "red")) +
  scale_x_continuous(
    breaks = seq(0, 100, by = 20),
    limits = c(0, 100)
  ) +
  labs(
    title = "Overlayed Density of MAGA Thermometer Ratings by Party",
    x = "Thermometer Rating (0–100)",
    y = "Density"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5)
  )

```



```{r}
#| label: weights

anes_2024_clean <- read_csv("../Python Files/Streamlit/data/ANES_2024_clean.csv")

anes_subset <- subset(anes_2024_clean, 
                      !is.na(full_var_psu) & 
                      !is.na(full_var_stratum) & 
                      !is.na(post_full))

# Define the design object using post-election weights (example)
anes_design <- svydesign(
  ids = ~full_var_psu,
  strata = ~full_var_stratum,
  weights = ~post_full,
  data = anes_subset,
  nest = TRUE
)

# Use svytable() to get proper weighted counts
tab <- svytable(~V242325, design = anes_design)
df <- as.data.frame(tab)
names(df) <- c("response", "weighted_count")

df <- df |>
  mutate(response = case_when(
    response == -9 ~ "Refused", 
    response == -8 ~ "Don’t know",
    response == -7 ~ "Insufficient partial, interview deleted",
    response == -6 ~ "No post interview",
    response == -5 ~ "Sufficient partial, breakoff",
    response == -1 ~ "Inapplicable",
    response == 1 ~ "More difficult",
    response == 2 ~ "Easier",
    response == 3 ~ "Keep these rules about the same"
  ))


ggplot(df, aes(y = response, x = weighted_count)) +
  geom_bar(stat = "identity") +
  labs(title = "Do you think the federal government should make it more
difficult for people to buy a gun than it is now, make it easier
for people to buy a gun, or keep these rules about the same
as they are now?",
       x = "Response", y = "Weighted Count") +
    scale_x_continuous(labels = scales::comma_format()) +
  theme_minimal()




# Step 1: Clean + recode
anes_subset_2 <- anes_2024_clean |>
  filter(
    !is.na(full_var_psu),
    !is.na(full_var_stratum),
    !is.na(post_full),
    !is.na(V242325),
    !is.na(poli_party_reg)
  ) |>
  mutate(
    V242325 = case_when(
      V242325 == -9 ~ "Refused", 
      V242325 == -8 ~ "Don’t know",
      V242325 == -7 ~ "Insufficient partial, interview deleted",
      V242325 == -6 ~ "No post interview",
      V242325 == -5 ~ "Sufficient partial, breakoff",
      V242325 == -1 ~ "Inapplicable",
      V242325 == 1 ~ "More difficult",
      V242325 == 2 ~ "Easier",
      V242325 == 3 ~ "Keep these rules about the same"
    ),
    poli_party_reg = case_when(
      poli_party_reg == -9 ~ "Refused",
      poli_party_reg == -8 ~ "Don’t know",
      poli_party_reg == -1 ~ "Inapplicable",
      poli_party_reg == 1 ~ "Democratic party",
      poli_party_reg == 2 ~ "Republican party",
      poli_party_reg == 4 ~ "None or independent",
      poli_party_reg == 5 ~ "Another party"
    )
  )

# Step 2: Define survey design
anes_design <- svydesign(
  ids = ~full_var_psu,
  strata = ~full_var_stratum,
  weights = ~post_full,
  data = anes_subset_2,
  nest = TRUE
)

# Step 3: Get weighted counts by response and party
tab <- svytable(~poli_party_reg + V242325, design = anes_design)
df <- as.data.frame(tab)
names(df) <- c("poli_party_reg", "V242325", "weighted_count")

# Step 4: Plot
ggplot(df, aes(y = poli_party_reg, x = weighted_count, fill = V242325)) +
  geom_col(position = "fill") +
  scale_x_continuous(labels = scales::percent_format()) +
  labs(
    title = "Do you think the federal government should make it more
difficult for people to buy a gun than it is now, make it easier
for people to buy a gun, or keep these rules about the same?"
  ) +
  theme_minimal()
```
